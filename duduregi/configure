#!/bin/bash

SUPPOTED_TARGETDEVICES=( default minnowmax)

show_help() {
echo "Usage: configure [options]"
echo "Options: [defaults in brackets after descriptions]"
echo
echo "Standard options:"
echo "  --help                 print this message"
echo "  --with-digitalcluster  build with digital cluster feature (on 2nd display)"
echo "  --with-reardisplay     build with rear display feature (on 3rd display)"
echo "  --without-maindisplay  build without main display"
echo "  --without-wlcompositor build without wayland compositor feature (deprecated)"
echo "  --without-webengine    build with WebView (WebKit) instead of WebEngine"
echo "  --target-device=NAME   Set JS configuration for specific target device"
echo ""
echo "Supported target devices:"
for name in "${SUPPOTED_TARGETDEVICES[@]}"
do
	echo "  $name"
done
}

if [ "$1" = -h -o "$1" = -help -o "$1" = --help ]
then
    show_help
	exit
fi

SUPPORT_MAINDISPLAY=1
SUPPORT_DCLUSTER=0
SUPPORT_REARDISPLAY=0
SUPPORT_WLCOMPOSITOR=1
SUPPORT_WEBENGINE=1
SUPPORT_DBUS=1
TARGET_DEVICE=default
OPTARGS=""

for opt do
    optval="${opt#*=}"
    case "$opt" in
    --without-maindisplay)
		SUPPORT_MAINDISPLAY=0
	;;
    --with-digitalcluster)
		SUPPORT_DCLUSTER=1
	;;
    --with-reardisplay)
		SUPPORT_REARDISPLAY=1
	;;
    --without-wlcompositor)
		SUPPORT_WLCOMPOSITOR=0
	;;
    --without-webengine)
		SUPPORT_WEBENGINE=0
	;;
    --target-device=*)
		for name in "${SUPPOTED_TARGETDEVICES[@]}"
		do
			if [ $name = $optval ]; then
                TARGET_DEVICE=$optval
				break
			fi
		done
		if [ $optval != $TARGET_DEVICE ]; then
			show_help
			echo
			echo "\"$optval\" is not supported target device"
			exit
		fi
	;;
    --help)
	show_help
	exit
	;;
	*)
		OPTARGS="$opt $OPTARGS"
	;;
    esac
done

echo "Build configuration"
echo "  SUPPORT_MAINDISPLAY=$SUPPORT_MAINDISPLAY"
echo "  SUPPORT_DIGITALCLUSTER=$SUPPORT_DCLUSTER"
echo "  SUPPORT_REARDISPLAY=$SUPPORT_REARDISPLAY"
echo "  SUPPORT_WLCOMPOSITOR=$SUPPORT_WLCOMPOSITOR"
echo "  SUPPORT_WEBENGINE=$SUPPORT_WEBENGINE"
echo "  SUPPORT_DBUS=$SUPPORT_DBUS"
echo "  TARGET_DEVICE=$TARGET_DEVICE"
echo "  OPTARGS: $OPTARGS"
echo

printf "Generating duduregi.pro ..."
echo "QT += quick qml network" > duduregi.pro

if [ "$SUPPORT_WEBENGINE" = "1" ]; then
echo "QT += webenginewidgets" >> duduregi.pro
else
echo "QT += webkitwidgets" >> duduregi.pro
fi

if [ "$SUPPORT_WLCOMPOSITOR" = "1" ]; then
echo "DEFINES += QT_COMPOSITOR_QUICK" >> duduregi.pro
echo "QT += compositor" >> duduregi.pro

echo "QT += compositor-private" >> duduregi.pro
echo "CONFIG +=wayland-scanner" >> duduregi.pro
echo "WAYLANDSERVERSOURCES += protocols/ivi-controller.xml" >> duduregi.pro
echo "CONFIG += link_pkgconfig" >> duduregi.pro
echo "PKGCONFIG += wayland-server" >> duduregi.pro
echo "HEADERS += GeniviWaylandIVIExtension.h" >> duduregi.pro
echo "SOURCES += GeniviWaylandIVIExtension.cpp" >> duduregi.pro

fi

if [ "$SUPPORT_DCLUSTER" = "1" ]; then
echo "HEADERS += digitalcluster.h" >> duduregi.pro
echo "SOURCES += digitalcluster.cpp" >> duduregi.pro
fi

if [ "$SUPPORT_REARDISPLAY" = "1" ]; then
echo "HEADERS += reardisplay.h" >> duduregi.pro
echo "SOURCES += reardisplay.cpp" >> duduregi.pro
echo "OTHER_FILES += rearmain.qml" >> duduregi.pro
fi

if [ "$SUPPORT_DBUS" = "1" ]; then
echo "QT += dbus" >> duduregi.pro
fi
echo "QT += multimedia" >> duduregi.pro

cat duduregi.pro.in >> duduregi.pro


echo $'\r'"Generating duduregi.pro ....................................... Done"


printf "Generating duduregiconfig.h ..."
cat duduregiconfig.h.in | sed \
-e "s/DUDUREGI_MAINDISPLAY 0/DUDUREGI_MAINDISPLAY $SUPPORT_MAINDISPLAY/" \
-e "s/DUDUREGI_DIGITALCLUSTER 0/DUDUREGI_DIGITALCLUSTER $SUPPORT_DCLUSTER/" \
-e "s/DUDUREGI_REARDISPLAY 0/DUDUREGI_REARDISPLAY $SUPPORT_REARDISPLAY/" \
-e "s/DUDUREGI_WAYLAND_COMPOSITOR 0/DUDUREGI_WAYLAND_COMPOSITOR $SUPPORT_WLCOMPOSITOR/" \
-e "s/DUDUREGI_WEBENGINE 0/DUDUREGI_WEBENGINE $SUPPORT_WEBENGINE/" \
-e "s/DUDUREGI_DBUS 0/DUDUREGI_DBUS $SUPPORT_DBUS/" \
> duduregiconfig.h
echo $'\r'"Generating duduregiconfig.h ................................... Done"

printf "Generating config.js ..."
JSCONFIG="config-$TARGET_DEVICE.js"
if [ -f "$JSCONFIG" ]; then
	cp -f config-default.js config.js.local
	if [ $JSCONFIG != "config-default.js" ]; then
		cat $JSCONFIG >> config.js.local
	fi
	if [ ! -f "config.js" ]; then
		cp config.js.local config.js
echo $'\r'"Generating config.js .......................................... Done"
	else
echo $'\r'"Generating config.js ................................ Already Exists"
echo $'\r'"                     ...................... saved as config.js.local"
	fi
else
echo $'\r'"Generating config.js .......................................... Failure"
echo "Error, could not find $JSCONFIG."
exit
fi
echo

if [ -f /opt/windriver/bin/qmake ]; then
	echo "Found Qt Build for Wind River: /opt/windriver"
	echo "/opt/windriver/bin/qmake will be used for build"
	/opt/windriver/bin/qmake $OPTARGS && echo "Makefile generated"
else
	qmake $OPTARGS && echo "Makefile generated"
fi
